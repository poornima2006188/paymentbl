<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeFlow Escrow Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-weight: 600;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #818cf8, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
        }

        .milestone-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .milestone-info h4 {
            margin: 0;
            font-size: 1.125rem;
        }

        .milestone-info p {
            margin: 5px 0 0;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-paid { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .status-pending { background: rgba(234, 179, 8, 0.2); color: var(--warning); }

        #log {
            margin-top: 40px;
            background: black;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            color: #4ade80;
            max-height: 200px;
            overflow-y: auto;
        }

        .input-group {
            margin-bottom: 25px;
        }

        input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TradeFlow Dashboard</h1>
        <p class="subtitle">Smart Escrow Settlement & Milestone Tracking</p>

        <div class="input-group">
            <label>Payment ID (Hashed)</label>
            <input type="text" id="paymentIdInput" value="0x1234567890123456789012345678901234567890123456789012345678901234">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Contract Value</div>
                <div class="stat-value" id="totalValue">0.00 ETH</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Amount Released</div>
                <div class="stat-value" id="releasedValue">0.00 ETH</div>
            </div>
        </div>

        <div style="margin-bottom: 30px; display: flex; gap: 10px;">
            <button class="btn" onclick="initEscrow()">Initialize New Escrow</button>
            <button class="btn btn-outline" onclick="loadStatus()">Refresh Data</button>
        </div>

        <h3>Milestone Timeline</h3>
        <div class="milestone-list" id="milestones">
            <!-- Loaded via JS -->
        </div>

        <div id="log">> System ready. Waiting for initialization...</div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e";
        const ABI = [
            "function createEscrow(bytes32 paymentId, uint256 amount) external",
            "function releaseMilestone(bytes32 paymentId, uint index) external",
            "function escrows(bytes32) view returns (uint256 totalAmount, uint256 releasedAmount, bool hold, bool delay)",
            "function milestones(bytes32, uint256) view returns (string name, uint256 percentage, bool released)"
        ];

        let provider, signer, contract;

        async function init() {
            try {
                // Hardhat Local Node
                provider = new ethers.JsonRpcProvider("http://localhost:8545");
                signer = await provider.getSigner(); 
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                log("Connected to Hardhat Local Node");
                loadStatus();
            } catch (e) {
                log("Error: " + e.message, "danger");
            }
        }

        async function initEscrow() {
            try {
                const pid = document.getElementById('paymentIdInput').value;
                const amount = ethers.parseEther("100"); // 100 ETH demo
                log("Creating escrow for " + pid.substring(0, 10) + "...");
                const tx = await contract.createEscrow(pid, amount);
                await tx.wait();
                log("Escrow Created Successfully!");
                loadStatus();
            } catch (e) {
                log("Error: " + e.message);
            }
        }

        async function loadStatus() {
            const pid = document.getElementById('paymentIdInput').value;
            const data = await contract.escrows(pid);
            
            document.getElementById('totalValue').innerText = ethers.formatEther(data.totalAmount) + " ETH";
            document.getElementById('releasedValue').innerText = ethers.formatEther(data.releasedAmount) + " ETH";

            const mList = document.getElementById('milestones');
            mList.innerHTML = "";

            for (let i = 0; i < 3; i++) {
                const m = await contract.milestones(pid, i);
                const div = document.createElement('div');
                div.className = "milestone-item";
                div.innerHTML = `
                    <div class="milestone-info">
                        <h4>${m.name}</h4>
                        <p>${m.percentage}% of total value</p>
                    </div>
                    <div>
                        ${m.released 
                            ? '<span class="status-badge status-paid">Released</span>' 
                            : `<button class="btn btn-outline" onclick="release(${i})">Release Funds</button>`}
                    </div>
                `;
                mList.appendChild(div);
            }
        }

        async function release(index) {
            try {
                const pid = document.getElementById('paymentIdInput').value;
                log(`Releasing milestone ${index}...`);
                const tx = await contract.releaseMilestone(pid, index);
                await tx.wait();
                log(`Milestone ${index} released!`);
                loadStatus();
            } catch (e) {
                log("Error: " + e.message);
            }
        }

        function log(msg, type = "") {
            const l = document.getElementById('log');
            l.innerHTML += `<br>> ${msg}`;
            l.scrollTop = l.scrollHeight;
        }

        window.onload = init;
    </script>
</body>
</html>
